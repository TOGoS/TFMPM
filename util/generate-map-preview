#!/usr/bin/env php
<?php

$selfDir = dirname(__DIR__);
require_once "$selfDir/init-environment.php";
require_once "$selfDir/init-error-handling.php";

$selfGitDir = "$selfDir/.git";
$blobRepoDir = getenv('HOME')."/.ccouch";
$metalogDir = "$selfDir/logs";
if( !is_dir($metalogDir) ) mkdir($metalogDir, 0777, true);

$repo = new TOGoS_PHPN2R_FSSHA1Repository($blobRepoDir);
$runner = new TFMPM_FactorioRunner($repo);

$selfCommitShellCmd = "git --git-dir=".escapeshellarg($selfGitDir)." rev-parse HEAD";
$selfCommitId = `$selfCommitShellCmd`;

$metalogFile = $metalogDir."/".date('Y_m_d').".jsonl";
TFMPM_SystemUtils::mkparentDirs($metalogFile);

$params = array(
	'mapSeed' => 1234,
	'factorioCommitId' => 'bed13417c5e1ac9e8408ec0e75043bff71e85f32',
	'mapScale' => 1,
	'slopeShading' => '0.3',
	'mapOffset' => array(0,0),
);
$params = TFMPM_FactorioRunner::normalizeParams($params);

$result = $runner->generateMapPreview($params);
$metalogRecord = array(
	'date' => date('c'),
	'tfmpmCommitId' => $selfCommitId,
	'generationParams' => $params,
	'generationResult' => $result,
);


// ".jsonl" extension as recommended by http://jsonlines.org/

$metalogStream = fopen( $metalogFile, "ab" );
fwrite($metalogStream, json_encode($metalogRecord)."\n");
fclose($metalogStream);

echo json_encode($metalogRecord,JSON_PRETTY_PRINT), "\n";
echo "Recorded in $metalogFile\n";
