#!/usr/bin/env php
<?php

$selfDir = dirname(__DIR__);
require_once "$selfDir/init-environment.php";
require_once "$selfDir/init-error-handling.php";


$paramMetadata = array(
	'map seed' => array(),
	'factorio commit ID' => array(),
	'data commit ID' => array(
		'requiresValue' => false
	),
	'map scale' => array(
		'defaultValue' => 1,
	),
	'slope shading' => array(
		'defaultValue' => '0.3'
	),
	'map width' => array(
		'defaultValue' => 1024
	),
	'map offset' => array(
		'defaultValue' => '0,0'
	),
	'report quantities' => array(
		'description' => 'List of names of prototype to report placement statistics about',
		'defaultValue' => '',
	),
);
$paramReMap = array();
foreach( $paramMetadata as $k=>&$info ) {
	$info['name'] = EarthIT_Schema_WordUtil::toCamelCase($k);
	$argRoot = "--".EarthIT_Schema_WordUtil::toKebabCase($k);
	$info['argRoot'] = $argRoot;
	$re = "/^$argRoot=(.*)$/";
	$paramReMap[$re] = $info;
}; unset($info);

$params = array();
for( $i=1; $i<count($argv); ++$i ) {
	$arg = $argv[$i];
	foreach( $paramReMap as $regex=>$paramInfo ) {
		if( preg_match($regex, $arg, $bif) ) {
			$params[$paramInfo['name']] = $bif[1];
			continue 2;
		}
	}
	if( $arg == '--help' ) {
		echo "Options:\n";
		foreach( $paramMetadata as $param ) {
			echo "  {$param['argRoot']}=...";
			if( isset($param['defaultValue']) ) echo " (default: {$param['defaultValue']})";
			echo "\n";
		}
		exit(0);
	}
	fwrite(STDERR, "Error: Unrecognized argument: ${arg}\nTry --help for help.\n");
}
$unspecifiedParams = array();
foreach( $paramMetadata as $param ) {
	if( !isset($params[$param['name']]) ) {
		$requiresValue = isset($param['requiresValue']) ? $param['requiresValue'] : true;
		if( isset($param['defaultValue']) ) {
			$params[$param['name']] = $param['defaultValue'];
		} else if( $requiresValue ) {
			$unspecifiedParams[] = $param['name'];
		}
	}
}
if( count($unspecifiedParams) ) {
	fwrite(STDERR, "Error: No values given (and no defaults) for the following parameters: ".implode(", ", $unspecifiedParams)."\n");
	exit(1);
}

$selfGitDir = "$selfDir/.git";
$blobRepoDir = getenv('HOME')."/.ccouch";
$metalogDir = "$selfDir/logs";
if( !is_dir($metalogDir) ) mkdir($metalogDir, 0777, true);

$runner = $TFMPM_Registry->factorioRunner;
$systemUtil = $TFMPM_Registry->systemUtil;

$selfCommitShellCmd = "git --git-dir=".escapeshellarg($selfGitDir)." rev-parse HEAD";
$selfCommitId = trim(`$selfCommitShellCmd`);
if( $selfCommitId === '' ) {
	fwrite(STDERR, "Warning: Unable to determine own commit ID\n");
	$selfCommitId = null;
}

$metalogFile = $metalogDir."/".date('Y_m_d').".jsonl";
$systemUtil->mkparentDirs($metalogFile);

$params = TFMPM_FactorioRunner::normalizeParams($params);

$startTime = date('c');
$result = $runner->generateMapPreview($params);
$endTime = date('c');
$metalogRecord = array(
	'startTime' => $startTime,
	'endTime' => $endTime,
	'tfmpmCommitId' => $selfCommitId,
	'generationParams' => $params,
	'generationResult' => $result,
);


// ".jsonl" extension as recommended by http://jsonlines.org/

$metalogStream = fopen( $metalogFile, "ab" );
fwrite($metalogStream, json_encode($metalogRecord)."\n");
fclose($metalogStream);

echo json_encode($metalogRecord,JSON_PRETTY_PRINT), "\n";
